# Child protection with parental drug or alcohol misuse.R

# 3 indicators generated by this script:
# Child protection with parental drug misuse
# Child protection with parental alcohol misuse
# Child protection with parental drug or alcohol misuse

# Full definition:
# Rate of Child Protection Case Conference where parental drug, alcohol or substance misuse (ie drug &/or alcohol)
# has been identified for children on the register at 31st July, per 10,000 population aged under 18.

#   Part 1 - Read in data downloaded from SG and format for functions
#   Part 2 - Run analysis functions 


###############################################################################. 
## Analyst Notes on generating this indicator data ----

# This script analyses Scottish Government data on the number of children protection parental alcohol, drugs, substance misuse by a local authority 

## Data are downloaded from the childrens social work publication on SG website:
## https://www.gov.scot/publications/childrens-social-work-statistics-scotland-2020-21/documents/
## See Excel files: Children's Social Work Statistics 2020-21 Additional Tables
## Table 4.6

# Figures are published for Scotland and local authorities only. (ScotPHO derive NHS board figures by aggregating council area figures)

# Each year (around March) the SG publish an additional year of data.
# The ScotPHO indicator raw dataset is generated by manually copying newly published data from the SG publication and adding this to historic indicator raw data excel file saved
# "\\Isdsf00d03\ScotPHO\Profiles\Data\Received Data\child_protection_with_parental_drug_or_alcohol_misuse_2012to2021.xlsx"
# Upadte filename suffix when adding new year of data.

# !!! IMPORTANT ANALYST NOTE: SG apply suppression to published data meaning it is not possible to calculate the Scotland total from the sum of local authorities
# ScotPHO indicator functions scripts usually rely on aggregating up smaller units of geographies
# to ensure the function script generates the correct scotland total insert a row for each year that has no label for the local authority but contains
# the number necessary to ensure the sum of the annual data sums to the correct scotland total (calcuate this by summing local authority total and substracting from published scotland total). 
# analysis funtion script will incorporate these numbers into scotland total but ignores the na when it comes to generating council level data

# ScotPHO apply suppression to the indicator as well but this occurs in the profiles tool data prepartion script 

## Previous years are saved here:
# \\Isdsf00d03\ScotPHO\1.Analysts_space\Jane\data/CSWS 2012-2020 revised 18'19.csv
# A:\ScotPHO Profiles\Data\Received Data/CSWS 2012-2020 revised 18'19.csv

## Manually added 2020/21 data into:
#\\Isdsf00d03\ScotPHO\1.Analysts_space\Jane\data/CP CSWS 2012_21 revised 19'20.xlsx
# \\Isdsf00d03\ScotPHO\Profiles\Data\Received Data/CP CSWS 2012_21 revised 19_20.xlsx

# DATA REVSION : In March 2022 revised figures for the previous year (2020) were relesed for some geographies
# Glasgow (drug & substance misuse), North Ayrshire all 3, South Lanarkshire all 3, West Dunbartonshire (alcohol & substance misuse) 

###############################################################################.

###############################################.
## Packages/Filepaths/Functions ----
###############################################.

source("./1.indicator_analysis.R") #Normal indicator functions
library("stringr")#for string_replace() function


################################################################################. 
## Part 1 - Read in data downloaded from SG and format for functions ----
################################################################################.

# open a lookup that will add la standard geography codes to the la names present in social work dataset
ca <- readRDS(paste0(lookups,"Geography/CAdictionary.rds")) %>%
  rename("ca"="code")

# read in excel - (note for 2022 update the 2020 data was overwritten with revised estimates and new 2021 data added)
# remember that SG apply suppression to source data therefore to ensure accurate aggregation to scotland total there will be some rows
# of data contains counts but that have NA as the la name.
# these rows will be summed to form Scotland total by R but will not appear as a row in final dataset

df_received<-read_excel("/PHI_conf/ScotPHO/Profiles/Data/Received Data/CP CSWS 2012_21 revised 19_20.xlsx") %>%
  mutate(la = str_replace(la, "Glasgow","Glasgow City"),
         la = str_replace(la, "Edinburgh, City of","City of Edinburgh"),
         la = str_replace(la, "Eilean Siar","Na h-Eileanan Siar"),
         la = str_replace(la, "&","and"),
         across(contains(c("drug", "alcohol", "substance_misuse")), as.numeric)) %>% #convert data columns to numeric (suppressed)
    left_join(ca, by = c("la" = "areaname"), all.x = TRUE) # join with council area lookup

#open 'geo_check_recieved dataframe and check that all la that have a 9 digit standard geo code have been matched
#there will be rows for 'na' but should be no rows where names of councils don't match to a geography code
geo_check_recieved <- df_received %>%
  group_by(la, ca) %>%
  summarise(count=n())

rm(ca)

# prepare child protection with parental drug use
parental_drug <- df_received %>% select(c(year,ca, drug)) %>% 
  rename("numerator"="drug") 
saveRDS(parental_drug, file=paste0(data_folder, "Prepared Data/child_protection_parental_drug_raw.rds")) 

# prepare child protection with parental drug use
parental_alcohol <- df_received %>% select(c(year,ca, alcohol)) %>% 
  rename("numerator"="alcohol") 
saveRDS(parental_alcohol, file=paste0(data_folder, "Prepared Data/child_protection_parental_alcohol_raw.rds")) 

# prepare child protection with substance misuse
parental_substance <- df_received %>% select(c(year,ca, substance_misuse)) %>% 
  rename("numerator"="substance_misuse") 
saveRDS(parental_substance, file=paste0(data_folder, "Prepared Data/child_protection_parental_substance_misuse_raw.rds")) 


################################################################################.
## Part 2 - Run analysis functions for 3 indicators---- 
################################################################################. 

## Child protection with parental drug use
analyze_first(filename = "child_protection_parental_drug", geography = "council",               
              measure = "crude", yearstart = 2012, yearend = 2021, 
              time_agg = 1, pop = "CA_pop_under18", adp = TRUE) 

analyze_second(filename = "child_protection_parental_drug", measure = "crude", time_agg = 1,               
               ind_id = 4130, year_type = "July snapshot", crude_rate = 10000)


## Child protection with parental alcohol use
analyze_first(filename = "child_protection_parental_alcohol", geography = "council",               
              measure = "crude", yearstart = 2012, yearend = 2021, 
              time_agg = 1, pop = "CA_pop_under18", adp = TRUE) 

analyze_second(filename = "child_protection_parental_alcohol", measure = "crude", time_agg = 1,               
               ind_id = 4110, year_type = "July snapshot", crude_rate = 10000)


## Child protection with parental substance  misuse
analyze_first(filename = "child_protection_parental_substance_misuse", geography = "council",               
              measure = "crude", yearstart = 2012, yearend = 2021, 
              time_agg = 1, pop = "CA_pop_under18", adp = TRUE) 

analyze_second(filename = "child_protection_parental_substance_misuse", measure = "crude", time_agg = 1,               
               ind_id = 4153, year_type = "July snapshot", crude_rate = 10000)


###END ----

