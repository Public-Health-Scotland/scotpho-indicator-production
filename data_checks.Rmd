---
title: "ScotPHO Profile indicator Data Quality Checks"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r, include=F, warning=F, message=F}

source("1.indicator_analysis.R") 
source("2.deprivation_analysis.R")

data_folder <- "/PHI_conf/ScotPHO/Profiles/Data/"
filename <- "deaths_under75_dz11"
old_file <- "default"
check_extras <- c()

```

# Data Checks `r filename` {.tabset .tabset-pills}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)



library(stringr)
library(reactable)
library(reactablefmtr)
```

## Initial Checks

```{r, include=FALSE, echo= FALSE}

#read in geography code names dictionary
code_dictionary <- readRDS(paste0(data_folder,"Lookups/Geography/codedictionary.rds")) 

#Read in indicator file being checked
data_indicator <- readRDS(paste0(data_folder, "Data to be checked/", filename, "_shiny.rds")) 

#Add geography code names
data_indicator <- left_join(x=data_indicator, y=code_dictionary, by="code")

#Test which optional geographies are present in dataset
board <- any(substr(data_indicator$code,1,3) == "S08")
ca <- any(substr(data_indicator$code,1,3) == "S12")
hscp <- any(substr(data_indicator$code,1,3) == "S37")
adp <- any(substr(data_indicator$code,1,3) == "S11")
locality <- any(substr(data_indicator$code,1,3) == "S99")
iz <- any(substr(data_indicator$code,1,3) == "S02")
  
# Pre-defined geographies that will be used in 'Check 3' comparing old & new file 
# All indicators include Scotland, NHS board, Council Area data so at least one geography included as    default.
# check_extras is an optional parameter that can be used to supply additional bespoke geography codes to check
check_codes <- c("S00000001","S08000015",check_extras) 

##If ca true add ca geography to check codes
if(ca==TRUE){check_codes <- c(check_codes,"S12000010")}

##If IZ true add IZ geography to check codes
if(iz==TRUE){check_codes <- c(check_codes,"S02001236")}

##If ADP true add ADP geography to check codes
if(adp==TRUE){check_codes <- c(check_codes,"S11000006")}

#Optional parament allows for old indicator name to be different to current name.
if (old_file == "default") {  #if no old_filename supplied default to new filename supplied
  old_filename <- {{filename}}
} else if (old_file != "default") {
  old_filename <- {{old_file}}}

#Recode missing CI to zeros rather than NA to allow report to run
data_indicator$lowci[is.na(data_indicator$lowci)] <- 0 # Converting NA's to 0s
data_indicator$upci[is.na(data_indicator$upci)] <- 0 # Converting NA's to 0s
  

#Reading last shiny data file loaded for comparisons.
# Need error handing if mathcing file name can't be found?
old_data_indicator <- read_csv(paste0(data_folder, "Shiny Data/", old_filename, "_shiny.csv")) 

```

Indicator: **`r filename`** <br> Date:
**`r format(Sys.time(), '%d %B, %Y %H:%M')`** <br>

------------------------------------------------------------------------

**New** indicator file:
/`r (paste0(data_folder, "Data to be checked/", filename, "_shiny.rds"))`<br>
**Old** indicator file (for comparisons):
/`r (paste0(data_folder, "Shiny Data/", old_filename, "_shiny.rds"))`

**Check extras** (optional parameter) `r check_extras` <br> **Geography
parameters** <br> NHS board: `r board` <br> Council area: `r ca` <br>
Health and Social Care Partnership: `r hscp` <br> Alcohol and Drugs
Partnership: `r adp`<br> HSC locality: `r locality`<br> Intermediate
zone: `r iz` <br>
------------------------------------------------------------------------------------

###Data check 1: ####What geographical levels and years are present, how
many unique geographies appear?

```{r include=FALSE}
#Aggegrate file to detect which geographies and years are present.
geo_checks <- data_indicator %>%
  mutate(geo_type=substr(code,1,3)) %>%
  group_by(geo_type, trend_axis) %>%
  summarise(count=n()) %>%
  spread(geo_type, count)

# ft_geo_check - summary table of years and geogrpahy types
# Conditional formatting on counts of geography types (except HSCP locality)
# Not sure how many localities there are supposed to be?
# Not sure how to handle indicators with ADP or only Council area - need to think about this...

ft_geo_check <- flextable(geo_checks) %>%
  color(~ S08!=14, ~S08, color = "red") # Should be 14 NHS board

if(ca == TRUE) {ft_geo_check <- ft_geo_check %>%  color(~ S12!=32, ~S12, color = "red")}    #should be 32 councils
if(adp == TRUE) {ft_geo_check <- ft_geo_check %>%  color(~ S11!=30, ~S11, color = "red")}   #should be 30 ADP
if(hscp == TRUE) {ft_geo_check <- ft_geo_check %>%  color(~ S37!=31, ~S37, color = "red")}  #should be 31 hscp
if(iz == TRUE) {ft_geo_check <- ft_geo_check %>%  color(~ S02!=1279, ~S02, color = "red")}  #should be 1279 2011 IZ

ft_geo_check <- ft_geo_check %>%
  autofit()

#saving flextable as image to work around pandoc issues
save_as_image(ft_geo_check, path = "check1.png")

```

Are the expected geographies appearing for all expected years?<br> Cells
contain the number of unique geography codes split by geography
type.<br> Conditional formatting highlights where geographies present
are not equal to expected (e.g. 14 NHS boards, 32 councils or 31
HSCP)<br> If some geographies are missing consider:<br> Is any
suppression already applied to the dataset?<br> Might there legitimately
be no data for that area (e.g. there might have been no deaths in that
intermediate zone)?

```{r, out.width = "400px", echo=FALSE}
knitr::include_graphics("check1.png")

#print flextable - this method of printing flextables should work when pandoc gets updated
#ft_geo_check 

```

------------------------------------------------------------------------

###Data check 2: ####How many new rows added in latest update?

**Note** some indicators generate data for geographies that are not
available in live tool (e.g. alcohol mortality we generate IZ data but
this is not routinely published to avoid secondary disclosure)

```{r, include=FALSE}
new_row <- nrow(data_indicator)
old_row <- nrow(old_data_indicator)

```

1.Rows in new shiny file: **`r new_row`** <br> 2.Rows added compared to
last file: **`r paste0(c(new_row-old_row))`**

------------------------------------------------------------------------

------------------------------------------------------------------------

###Data check 3: ####Rates & Confidence intervals Do any rates fall
outwith the confidence limits - they shouldn't!?

```{r, echo=FALSE}
# Check no rates/percentages sit outside of CI range  
 confidence_check <- data_indicator %>% 
  mutate(ci_error = ifelse(rate<lowci | rate>upci, TRUE, FALSE)) %>%
  summarise(ci_error_total = sum(ci_error, na.rm = TRUE))

```

```{r, echo=FALSE}
ifelse(confidence_check$ci_error_total == 0, "No rates outwith confidence limits :-)",
"Uh-oh looks like there are some rates outwith confidence limits :(")

```

------------------------------------------------------------------------

###Data check 4: ####Scotland & NHS boards Does Scotland rate seem like
a sensible figure, how wide are the confidence intervals? <br> Does
Scotland rate look about average of all NHS boards.<br> Are there any
outliers or strange looking confidence intervals (expect island boards
to have wide CI)

```{r, echo=FALSE}
#Filter Scotland value for use in chart
scot_value <-data_indicator %>% 
  filter((code=="S00000001") & year==max(year)) %>% 
  select(rate)

#Selecting Health boards and Scotland for latest year in dataset
scot_check <- ggplot(data = data_indicator %>% 
                       filter((substr(code, 1, 3)=="S08" | code=="S00000001") 
                                        & year== max(year)), aes(areaname, rate)) +
  geom_point(stat = "identity") +
  geom_hline(yintercept= scot_value$rate[1], linetype="dashed", color = "red")+
  geom_errorbar(aes(ymax=upci, ymin=lowci), width=0.5)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(x = "", y =  "Measure")

```

```{r, echo=FALSE}
scot_check
```

------------------------------------------------------------------------

### Data check 5:

#### Are geographies that ought to be the same matching?

Most council areas are the same as HSC Partnerships. If these
geographies are available, use the chart to look at whether the rates
for council are and HSCP match. Also check if HSC locality rates seem
consistent with partnership data (i.e partnership rate should be roughly
in the middle)

```{r, include=FALSE}

#Selecting Council area, HSCP and its localities for latest year in dataset
#city of edinburgh council = S1200036
#city of edinburgh partnership = S37000012
#Edinburgh localities = S99000044,45,46,47

#Filter City of Edinburgh value central line in chart below
ed_value <- data_indicator %>% 
  filter((code=="S12000036") & year==max(year)) %>% 
  select(rate)

#Generate chart showing rates for all edinburgh geographies for latest year
edinburgh_chart <- ggplot(data = data_indicator %>% 
         filter((code =="S12000036" | code=="S37000012"
                |code=="S99000043"|code=="S99000044"|code=="S99000045"|code=="S99000046") 
                & year== max(year)), aes(areaname, rate)) +
  geom_point(stat = "identity") +
  geom_hline(yintercept= ed_value$rate, linetype="dashed", color = "red")+
  geom_errorbar(aes(ymax=upci, ymin=lowci), width=0.5) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  labs(x = "", y =  "Measure")

# Additional check of numerators (where present) to test if all numerators agree

if(all(data_indicator$numerator != "", na.rm = TRUE)){    #if numerator column is not blank
edinburgh_data <- data_indicator %>%        # create data frame filtered for edinburgh geographies
  filter(code =="S12000036" | code=="S37000012" | code=="S99000043"| 
           code=="S99000044"|code=="S99000045"|code=="S99000046") %>%
  mutate(geotype=substr(code,1,3)) %>%
  group_by(year, geotype) %>%
  summarise(numerator=sum(numerator)) %>%
  spread(geotype, numerator) %>%
  mutate(ca_partnership=ifelse((hscp==TRUE && ca==TRUE),(round(S12-S37,2)),0),  #create fields that test for differences - use rounded figures
         partnership_localities=ifelse(locality==TRUE,(round(S99-S37,2)),0), #if dataset includes localities check sum
         localities_ca=ifelse(locality==TRUE,(round(S99-S12,2)),0),
         check_tot=round(sum(ca_partnership,partnership_localities,localities_ca),2))}

if(all(data_indicator$numerator == "", na.rm = TRUE)){
  ed_flex <- "No numerator to cross reference totals"
} else if (sum(edinburgh_data$check_tot, na.rm = T) !=0){
  ed_flex <- flextable(edinburgh_data) %>%
    fontsize(part = "header", size = 16) %>%
    color(~ check_tot!=0, ~check_tot, color = "red") %>%
    autofit()
} else if (sum(edinburgh_data$check_tot, na.rm = T) ==0){
  ed_flex <- "Numerators for Edinburgh council, HSCP and localities (if present) all agree :-)"
}


```

```{r, echo=FALSE}
if(ca==TRUE & hscp==TRUE){ #only include chart when either ca or hscp data available
edinburgh_chart}

if(ca==FALSE | hscp==FALSE){ #only include chart when either ca or hscp data available
"No ca or hscp rates to check"
}

```

If dataset contains numerators check if for agreement between geography
types. <br>

```{r, echo=FALSE}
if(ca==TRUE & hscp==TRUE){ #only include if ca and hscp data available
ed_flex}

if(ca==FALSE | hscp==FALSE){ #only include chart when either ca or hscp data available
"No ca or hscp numerators to check"
}

```

------------------------------------------------------------------------

###Data check 6: ####Are numerators likely to generate a robust
indicator?

The table below shows area types where more than 40% of the rows contain
numerators \<5. Use this table to assess if a particular geography type
is likely to be robust and useful. There is no definite point at which
an indicator is no longer robust but if a large proportion of your data
is small numbers then consider whether the data is worth publishing.
<br>

```{r include=FALSE}
ifelse(all(data_indicator$numerator == ""),
       "No numerator available",        #if no numerator data available print statement
small_count_data <- data_indicator  %>%# if numerator is available generate flextable data
  mutate(geo_type=substr(code,1,3)) %>%
  group_by(geo_type, year) %>%
  summarise(count=n(),
            u5=sum(numerator<5)) %>%
  mutate(percent_U5=u5/count*100,
         year =as.factor(year)) %>%
   filter(percent_U5>40) %>%
   ungroup())

```

```{r echo=FALSE}
#if numerator column is available (i.e. not all blank) produce flextable summarising counts of small numbers
if(all(data_indicator$numerator != "", na.rm = TRUE)){
  flextable(small_count_data)
}

```

```{r, echo=FALSE}
##if numerator column is not available (i.e. all blank) skip check and notify user
if(all(data_indicator$numerator == "")){
  "No numerators available in dataset"
}

```

------------------------------------------------------------------------

```{r, echo=FALSE, message=FALSE, include=FALSE}
qa_rates <- function(geo_code) {
  if(!is.numeric(data_indicator$numerator)){
    data_indicator %<>% mutate(numerator = as.numeric(numerator)) 
    
    old_data_indicator %<>% mutate(numerator = as.numeric(numerator)) 
  }
  new_data <- data_indicator %>%
  filter(str_detect(code, geo_code)) %>%
         #year != max(year)) %>% # remove most recent year for comparison with old data
  select(code, year, areaname, numerator, rate) %>%
  mutate(numerator = round(numerator, 3),
         rate = round(rate, 3))

old_data <- old_data_indicator %>%
  filter(str_detect(code, geo_code)) %>%
  select(code, year, numerator, rate) %>%
     mutate(numerator = round(numerator, 3),
         rate = round(rate, 3))

 both_data <- left_join(x = new_data, y = old_data, by=c("code", "year")) %>%
   rename(numerator_new = numerator.x,
          rate_new = rate.x,
          numerator_old = numerator.y,
          rate_old = rate.y)
 
 rm(new_data, old_data)
 
 both_data %<>% 
 # calculate difference in numerator and rate
  mutate(numerator_diff = numerator_new - numerator_old,
         rate_diff = rate_new - rate_old) %>% 
  # assign flag to rows with a difference in numerator or rate
  mutate(diff_flag = case_when(numerator_diff > 0 | rate_diff > 0 ~ T,
                               numerator_diff < 0 | rate_diff < 0 ~ T,
                               TRUE ~ FALSE)) %>% 
  mutate(numerator_percent_diff = numerator_diff/numerator_new*100,
         rate_percent_diff = rate_diff/rate_new*100) %>% 
  # Assigns significant difference flag if percentage difference is over 5% (what % should be assigned?)
  mutate(significant_diff_flag = case_when(numerator_percent_diff > 5 | rate_percent_diff > 5 ~ T,
                                           numerator_percent_diff <= -5 | rate_percent_diff <= -5 ~ T,
                                           TRUE ~ FALSE)) %>% 
  # assign colours for tables
  mutate(table_colours = case_when(
    diff_flag == FALSE ~ "#3BB118",
    diff_flag == TRUE & significant_diff_flag == FALSE ~ "#F3C525",
    diff_flag == TRUE & significant_diff_flag == TRUE ~ "#FC3934"
  ))  %>% 
  mutate(across(where(is.numeric), round, 3))


}


```

## Scotland Checks

### *Significant* difference in numerator or rate, Scotland level

```{r, echo=FALSE, message=FALSE}
scot_checks <- qa_rates(geo_code = "S00")

scot_significant_diff <- scot_checks %>%
   filter(significant_diff_flag == TRUE)

scot_checks %>%
  filter(significant_diff_flag == TRUE) %>% 
reactable(filterable = TRUE,
          columns = list(
            numerator_diff = colDef(
              style = color_scales(scot_significant_diff, color_ref = "table_colours")),
            rate_diff = colDef(
              style = color_scales(scot_significant_diff, color_ref = "table_colours")),
            table_colours = colDef(show = FALSE),
            diff_flag = colDef(show = FALSE),
            significant_diff_flag = colDef(show = FALSE)))
```

### Differences in Numerator or rate, Scotland Level

```{r, echo=FALSE, message=FALSE}
reactable(scot_checks,
          filterable = TRUE,
          columns = list(
            numerator_diff = colDef(
              style = color_scales(scot_checks, color_ref = "table_colours")),
            rate_diff = colDef(
              style = color_scales(scot_checks, color_ref = "table_colours")),
            table_colours = colDef(show = FALSE),
            diff_flag = colDef(show = FALSE),
            significant_diff_flag = colDef(show = FALSE)
          ))
```

## HB Checks

### Healthboards with a *Significant* Difference in Numerator or Rate

```{r, echo=FALSE, message=FALSE}
if(board==TRUE){
  
hb_checks <- qa_rates(geo_code = "S08")  
  
hb_significant_diff <- hb_checks %>%
   filter(significant_diff_flag == TRUE)

reactable(hb_significant_diff,
           filterable = TRUE,
          columns = list(
            numerator_diff = colDef(
              style = color_scales(hb_significant_diff, color_ref = "table_colours")),
            rate_diff = colDef(
              style = color_scales(hb_significant_diff, color_ref = "table_colours")),
            table_colours = colDef(show = FALSE),
            diff_flag = colDef(show = FALSE),
            significant_diff_flag = colDef(show = FALSE)
            ))

}

if(board==TRUE){
 
 # # Shows list of Health Boards with significant differences

 hb_signif_diff_list <- unique(hb_significant_diff$areaname) %>%
   as_tibble() %>% 
  rename("Health Boards with significant differences in numerator or rate" = value)

 reactable(hb_signif_diff_list)
 
 }

```

### Health Board Data

```{r, echo=FALSE, message=FALSE}
if(board==TRUE){

hb_checks <- qa_rates(geo_code = "S08")

reactable(hb_checks,
          filterable = TRUE,
          columns = list(
            numerator_diff = colDef(
              style = color_scales(hb_checks, color_ref = "table_colours")),
            rate_diff = colDef(
              style = color_scales(hb_checks, color_ref = "table_colours")),
            table_colours = colDef(show = FALSE),
            diff_flag = colDef(show = FALSE),
            significant_diff_flag = colDef(show = FALSE)
          ))

} else {print("Health Board data not available")}
```

## CA Checks

### Council Area with a *Significant* Difference in Numerator or Rate

```{r, echo=FALSE, message=FALSE}
if(ca==TRUE){
  
ca_checks <- qa_rates(geo_code = "S12")  
  
  ca_significant_diff <- ca_checks %>%
   filter(significant_diff_flag == TRUE)

 reactable(ca_significant_diff,
           filterable = TRUE,
          columns = list(
            numerator_diff = colDef(
              style = color_scales(ca_significant_diff, color_ref = "table_colours")),
            rate_diff = colDef(
              style = color_scales(ca_significant_diff, color_ref = "table_colours")),
            table_colours = colDef(show = FALSE),
            diff_flag = colDef(show = FALSE),
            significant_diff_flag = colDef(show = FALSE)))
}

if(ca==TRUE){
 
 # # Shows list of CAs with significant differences

 ca_signif_diff_list <- unique(ca_significant_diff$areaname) %>%
   as_tibble() %>% 
  rename("Council Areas with significant differences in numerator or rate" = value)

 reactable(ca_signif_diff_list)
 
 }

```

### Council Area Data

```{r, echo=FALSE, message=FALSE}
if(ca==TRUE){

ca_checks <- qa_rates(geo_code = "S12")


reactable(ca_checks,
          filterable = TRUE,
          columns = list(
            numerator_diff = colDef(
              style = color_scales(ca_checks, color_ref = "table_colours")),
            rate_diff = colDef(
              style = color_scales(ca_checks, color_ref = "table_colours")),
            table_colours = colDef(show = FALSE),
            diff_flag = colDef(show = FALSE),
            significant_diff_flag = colDef(show = FALSE)
          ))



} else {print("Council Area data not available")}
```

## IZ Checks

### Intermediate Zones with a *Significant* Difference in Numerator or Rate

```{r, echo=FALSE, message=FALSE}
if(iz==TRUE){ 

iz_checks <- qa_rates(geo_code = "S02")    
    
iz_significant_diff <- iz_checks %>%
   filter(significant_diff_flag == TRUE)

 reactable(iz_significant_diff,
           filterable = TRUE,
          columns = list(
            numerator_diff = colDef(
              style = color_scales(iz_significant_diff, color_ref = "table_colours")),
            rate_diff = colDef(
              style = color_scales(iz_significant_diff, color_ref = "table_colours")),
            table_colours = colDef(show = FALSE),
            diff_flag = colDef(show = FALSE),
            significant_diff_flag = colDef(show = FALSE)))
}

if(iz==TRUE){ 
 
 # # Shows list of IZs with significant differences

 iz_signif_diff_list <- unique(iz_significant_diff$areaname) %>%
   as_tibble() %>%
  rename("Intermediate Zones with significant differences in numerator or rate" = value)

 reactable(iz_signif_diff_list)
 
 }

```

### Intermediate Zone Data

```{r, echo=FALSE, message=FALSE}
if(iz==TRUE){

iz_checks <- qa_rates(geo_code = "S02")  
  
reactable(iz_checks,
          filterable = TRUE,
          columns = list(
            numerator_diff = colDef(
              style = color_scales(hb_checks, color_ref = "table_colours")),
            rate_diff = colDef(
              style = color_scales(hb_checks, color_ref = "table_colours")),
            table_colours = colDef(show = FALSE),
            diff_flag = colDef(show = FALSE),
            significant_diff_flag = colDef(show = FALSE)
          ))

} else {print("IZ level data not available")}
```

## HSCP Checks

### HSCP with a *Significant* Difference in Numerator or Rate

```{r, echo=FALSE, message=FALSE}
if(hscp==TRUE){
  
  hscp_checks <- qa_rates(geo_code = "S37")
  
  hscp_significant_diff <- hscp_checks %>%
   filter(significant_diff_flag == TRUE)

 reactable(hscp_significant_diff,
           filterable = TRUE,
          columns = list(
            numerator_diff = colDef(
              style = color_scales(hscp_significant_diff, color_ref = "table_colours")),
            rate_diff = colDef(
              style = color_scales(hscp_significant_diff, color_ref = "table_colours")),
            table_colours = colDef(show = FALSE),
            diff_flag = colDef(show = FALSE),
            significant_diff_flag = colDef(show = FALSE)))
}

if(hscp==TRUE){
 
 # # Shows list of HSCPs with significant differences

 hscp_signif_diff_list <- unique(hscp_significant_diff$areaname) %>%
   as_tibble() %>% 
  rename("HSCP's with significant differences in numerator or rate" = value)

 reactable(hscp_signif_diff_list)
 
}

```

### Health and Social Care Partnership Data

```{r, echo=FALSE, message=FALSE}
if(hscp==TRUE){

hscp_checks <- qa_rates(geo_code = "S37")

reactable(hscp_checks,
          filterable = TRUE,
          columns = list(
            numerator_diff = colDef(
              style = color_scales(hscp_checks, color_ref = "table_colours")),
            rate_diff = colDef(
              style = color_scales(hscp_checks, color_ref = "table_colours")),
            table_colours = colDef(show = FALSE),
            diff_flag = colDef(show = FALSE),
            significant_diff_flag = colDef(show = FALSE)
          ))


} else {print("HSCP data not available")}
```

## ADP Checks

### ADP with a *Significant* Difference in Numerator or Rate

```{r, echo=FALSE, message=FALSE}
if(adp==TRUE){
  
  adp_checks <- qa_rates(geo_code = "S11")
  
  adp_significant_diff <- adp_checks %>%
   filter(significant_diff_flag == TRUE)

 reactable(adp_significant_diff,
           filterable = TRUE,
          columns = list(
            numerator_diff = colDef(
              style = color_scales(adp_significant_diff, color_ref = "table_colours")),
            rate_diff = colDef(
              style = color_scales(adp_significant_diff, color_ref = "table_colours")),
            table_colours = colDef(show = FALSE),
            diff_flag = colDef(show = FALSE),
            significant_diff_flag = colDef(show = FALSE)))
}

if(adp==TRUE){
 
 # # Shows list of ADPs with significant differences

 adp_signif_diff_list <- unique(adp_significant_diff$areaname) %>%
   as_tibble() %>% 
  rename("ADP's with significant differences in numerator or rate" = value)

 reactable(adp_signif_diff_list)
 
}

```

### Alcohol and Drugs Partnership Data

```{r, echo=FALSE, message=FALSE}
if(adp==TRUE){

adp_checks <- qa_rates(geo_code = "S11")


reactable(adp_checks,
          filterable = TRUE,
          columns = list(
            numerator_diff = colDef(
              style = color_scales(adp_checks, color_ref = "table_colours")),
            rate_diff = colDef(
              style = color_scales(adp_checks, color_ref = "table_colours")),
            table_colours = colDef(show = FALSE),
            diff_flag = colDef(show = FALSE),
            significant_diff_flag = colDef(show = FALSE)
          ))



} else {print("ADP data not available")}
```

## HSC Locality Checks

### Locality with a *Significant* Difference in Numerator or Rate

```{r, echo=FALSE, message=FALSE}
if(locality==TRUE){
  
  locality_checks <- qa_rates(geo_code = "S99")
  
  locality_significant_diff <- locality_checks %>%
   filter(significant_diff_flag == TRUE)

 reactable(locality_significant_diff,
           filterable = TRUE,
          columns = list(
            numerator_diff = colDef(
              style = color_scales(locality_significant_diff, color_ref = "table_colours")),
            rate_diff = colDef(
              style = color_scales(locality_significant_diff, color_ref = "table_colours")),
            table_colours = colDef(show = FALSE),
            diff_flag = colDef(show = FALSE),
            significant_diff_flag = colDef(show = FALSE)))
}

if(locality==TRUE){
 
 # # Shows list of localities with significant differences

 locality_signif_diff_list <- unique(locality_significant_diff$areaname) %>%
   as_tibble() %>% 
  rename("Localities with significant differences in numerator or rate" = value)

 reactable(locality_signif_diff_list)
 
}

```

### Health and Social Care Locality Data

```{r, echo=FALSE, message=FALSE}
if(locality==TRUE){

locality_checks <- qa_rates(geo_code = "S99")

reactable(locality_checks,
          filterable = TRUE,
          columns = list(
            numerator_diff = colDef(
              style = color_scales(locality_checks, color_ref = "table_colours")),
            rate_diff = colDef(
              style = color_scales(locality_checks, color_ref = "table_colours")),
            table_colours = colDef(show = FALSE),
            diff_flag = colDef(show = FALSE),
            significant_diff_flag = colDef(show = FALSE)
          ))


} else {print("Locality data not available")}
```

## SUBTOTALS

```{r, echo=FALSE, message=FALSE}
qa_subtotals <- function(geography){
  subtotal_check %>% 
                        select(year, Scotland, geography) %>% 
                        mutate(
                          sub_diff = Scotland - subtotal_check[geography],
                          sub_percent_diff = sub_diff/Scotland*100,
                          diff_flag = if_else(as.logical(sub_percent_diff != 0), T, F),
                          signif_flag = case_when(as.logical(sub_percent_diff >= 5 | sub_percent_diff <= -5) ~ TRUE,
                                                      TRUE ~ FALSE),
                          table_colours = case_when(
                                                diff_flag == FALSE ~ "#3BB118",
                                                diff_flag == TRUE & signif_flag == FALSE ~ "#F3C525",
                                                diff_flag == TRUE & signif_flag == TRUE ~ "#FC3934"))
}
```

```{r, echo=FALSE, message=FALSE}
subtotal_check <- data_indicator %>% 
  mutate(geo_level = case_when(
                            str_detect(code, "S00000001") ~ "Scotland",
                            str_detect(code, "S08") ~ "Health_Board",
                            str_detect(code, "S12") ~ "Council_Area",
                            str_detect(code, "S37") ~ "HSC_Partnership",
                            str_detect(code, "S11") ~ "Alcohol_Drug_Partnership",
                            str_detect(code, "S99") ~ "HSC_Locality",
                            str_detect(code, "S02") ~ "Intermediate_Zone"),
         numerator = as.numeric(numerator)) %>% 
  group_by(geo_level, year) %>% 
  summarise(total_numerator = round(sum(numerator), 3)) %>%
  ungroup() %>% 
  pivot_wider(names_from = geo_level, values_from = total_numerator) %>% 
  select(year, Scotland, everything()) # reorder the columns

# checks HB vs Scotland, assigns flags and prints table
if(board==TRUE) {
  
  subtotal_check_hb <- qa_subtotals(geography = "Health_Board")
  
  
reactable(subtotal_check_hb,
          filterable = TRUE,
          columns = list(
            Health_Board = colDef(
              style = color_scales(subtotal_check_hb, color_ref = "table_colours")),
            table_colours = colDef(show = FALSE),
            sub_diff = colDef(show = FALSE),
            sub_percent_diff = colDef(show = FALSE),
            diff_flag = colDef(show = FALSE),
            signif_flag = colDef(show = FALSE)))
}

# checks CA vs Scotland and assigns flags
if(ca==TRUE) {
  subtotal_check_ca <- qa_subtotals(geography = "Council_Area")
  
  
  
  
reactable(subtotal_check_ca,
          filterable = TRUE,
          columns = list(
            Council_Area = colDef(
              style = color_scales(subtotal_check_ca, color_ref = "table_colours")),
            table_colours = colDef(show = FALSE),
            sub_diff = colDef(show = FALSE),
            sub_percent_diff = colDef(show = FALSE),
            diff_flag = colDef(show = FALSE),
            signif_flag = colDef(show = FALSE)))
  
    
}

# checks IZ vs Scotland and assigns flags
if(iz==TRUE) {
  subtotal_check_iz <- qa_subtotals(geography = "Intermediate_Zone") 
  
  
reactable(subtotal_check_iz,
          filterable = TRUE,
          columns = list(
            Intermediate_Zone = colDef(
              style = color_scales(subtotal_check_iz, color_ref = "table_colours")),
            table_colours = colDef(show = FALSE),
            sub_diff = colDef(show = FALSE),
            sub_percent_diff = colDef(show = FALSE),
            diff_flag = colDef(show = FALSE),
            signif_flag = colDef(show = FALSE)))  
    
}

# checks HSCP vs Scotland and assigns flags
if(hscp==TRUE) {
  subtotal_check_hscp <- qa_subtotals(geography = "HSC_Partnership")
  
  
reactable(subtotal_check_hscp,
          filterable = TRUE,
          columns = list(
            HSC_Partnership = colDef(
              style = color_scales(subtotal_check_hscp, color_ref = "table_colours")),
            table_colours = colDef(show = FALSE),
            sub_diff = colDef(show = FALSE),
            sub_percent_diff = colDef(show = FALSE),
            diff_flag = colDef(show = FALSE),
            signif_flag = colDef(show = FALSE)))  
    
}


# checks ADP vs Scotland and assigns flags
if(adp==TRUE) {
  subtotal_check_adp <- qa_subtotals(geography = "Alcohol_Drug_Partnership")
  
  
reactable(subtotal_check_adp,
          filterable = TRUE,
          columns = list(
            Alcohol_Drug_Partnership = colDef(
              style = color_scales(subtotal_check_adp, color_ref = "table_colours")),
            table_colours = colDef(show = FALSE),
            sub_diff = colDef(show = FALSE),
            sub_percent_diff = colDef(show = FALSE),
            diff_flag = colDef(show = FALSE),
            signif_flag = colDef(show = FALSE)))  
    
}

# checks HSC locality vs Scotland and assigns flags
if(locality==TRUE) {
  subtotal_check_locality <- qa_subtotals(geography = "HSC_Locality") 
  
  
reactable(subtotal_check_locality,
          filterable = TRUE,
          columns = list(
           HSC_Locality = colDef(
              style = color_scales(subtotal_check_locality, color_ref = "table_colours")),
            table_colours = colDef(show = FALSE),
            sub_diff = colDef(show = FALSE),
            sub_percent_diff = colDef(show = FALSE),
            diff_flag = colDef(show = FALSE),
            signif_flag = colDef(show = FALSE))) 
    
}
```

#### END
